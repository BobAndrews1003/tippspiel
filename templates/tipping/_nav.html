<!-- NAV_VERSION: 2026-02-20-railway-test -->

<nav class="nav">
  <div class="nav-inner">

    <!-- Brand -->
    <a class="nav-title"
       href="{% if request.user.is_authenticated and group %}{% url 'tippen' %}{% else %}{% url 'login' %}{% endif %}">
      {% if group %}{{ group.name }}{% else %}Tippspiel{% endif %}
    </a>

    <!-- Right controls -->
    <div class="nav-controls">

      <!-- Burger -->
      <button class="nav-iconbtn"
              type="button"
              aria-label="Menü"
              aria-controls="navDrawer"
              aria-expanded="false"
              data-nav-toggle="drawer">
        <span class="nav-burger" aria-hidden="true"></span>
      </button>

      {% if request.user.is_authenticated %}
        <!-- Account / Group dropdown -->
        <button class="nav-iconbtn"
                type="button"
                aria-label="Konto & Gruppe"
                aria-controls="navAccount"
                aria-expanded="false"
                data-nav-toggle="account">
          <span class="nav-avatar" aria-hidden="true">{{ request.user.username|slice:":1" }}</span>
        </button>
      {% endif %}
    </div>
  </div>

  <!-- Drawer backdrop -->
  <div class="nav-backdrop" id="navBackdrop" hidden></div>

  <!-- Drawer (links) -->
  <div class="nav-drawer" id="navDrawer" aria-hidden="true">
    <div class="nav-drawer-head">
      <div>
        <div class="nav-drawer-title">{% if group %}{{ group.name }}{% else %}Tippspiel{% endif %}</div>
        {% if request.user.is_authenticated %}
          <div class="muted small">{{ request.user.username }}</div>
        {% endif %}
      </div>
      <button class="nav-iconbtn" type="button" aria-label="Schließen" data-nav-close>
        ✕
      </button>
    </div>

    <div class="nav-drawer-body">
      <div class="nav-section-title">Menü</div>

      <div class="nav-links-vertical">
        {% if request.user.is_authenticated %}
          {% if group %}
            <a href="{% url 'tippen' %}"
               class="nav-link {% if request.resolver_match.url_name == 'tippen' %}active{% endif %}">
              Pronosticar
            </a>

            <a href="{% url 'spieltag' %}"
               class="nav-link {% if request.resolver_match.url_name == 'spieltag' %}active{% endif %}">
              Tabla por fecha
            </a>

            <a href="{% url 'tabelle' %}"
               class="nav-link {% if request.resolver_match.url_name == 'tabelle' %}active{% endif %}">
              Tabla general
            </a>

            <a href="{% url 'bonus_tips' %}"
               class="nav-link {% if request.resolver_match.url_name == 'bonus_tips' %}active{% endif %}">
              Pronosticos especiales
            </a>
          {% endif %}

          <a href="{% url 'join_group' %}"
             class="nav-link {% if request.resolver_match.url_name == 'join_group' %}active{% endif %}">
            Unirse a un grupo
          </a>

          <a href="{% url 'create_group' %}"
             class="nav-link {% if request.resolver_match.url_name == 'create_group' %}active{% endif %}">
            Crear un grupo
          </a>
        {% else %}
          <a href="{% url 'login' %}"
             class="nav-link {% if request.resolver_match.url_name == 'login' %}active{% endif %}">
            Login
          </a>

          <a href="{% url 'signup' %}"
             class="nav-link {% if request.resolver_match.url_name == 'signup' %}active{% endif %}">
            Registrieren
          </a>
        {% endif %}
      </div>
    </div>
  </div>

  {% if request.user.is_authenticated %}
    <!-- Account panel (right) -->
    <div class="nav-account" id="navAccount" aria-hidden="true">
      <div class="nav-account-head">
        <div class="nav-section-title">Cuenta</div>
        <button class="nav-iconbtn" type="button" aria-label="Schließen" data-nav-close>
          ✕
        </button>
      </div>

      <div class="nav-account-body">
        {% if my_groups and my_groups|length > 1 %}
          <div class="nav-section">
            <div class="nav-section-title">Grupo activo</div>
            <form method="post" action="{% url 'set_active_group' %}">
              {% csrf_token %}
              <select name="group_id" onchange="this.form.submit()">
                {% for g in my_groups %}
                  <option value="{{ g.id }}" {% if group and g.id == group.id %}selected{% endif %}>
                    {{ g.name }}
                  </option>
                {% endfor %}
              </select>
            </form>
          </div>
        {% endif %}

        {% if membership and membership.is_creator and group %}
          <div class="nav-section">
            <div class="nav-section-title">Join-Code</div>

            <div class="nav-joinbox">
              <code class="nav-code">{{ group.join_code }}</code>

              <div class="nav-join-actions">
                <button class="btn small" type="button"
                        onclick="navigator.clipboard.writeText('{{ group.join_code }}')">
                  Copiar código
                </button>

                <button class="btn small" type="button"
                        onclick="navigator.clipboard.writeText(window.location.origin + '{% url 'join_group' %}?code={{ group.join_code }}')">
                  Copiar enlace
                </button>
              </div>
            </div>
          </div>
        {% endif %}

        <div class="nav-section">
          <div class="nav-userrow">
            <span class="muted small">{{ request.user.username }}</span>

            <form method="post" action="{% url 'logout' %}">
              {% csrf_token %}
              <button type="submit" class="nav-logout">Logout</button>
            </form>
          </div>
        </div>
      </div>
    </div>
  {% endif %}
</nav>

<script>
(function () {
  const drawer = document.getElementById('navDrawer');
  const account = document.getElementById('navAccount');
  const backdrop = document.getElementById('navBackdrop');
  const toggles = document.querySelectorAll('[data-nav-toggle]');
  const closers = document.querySelectorAll('[data-nav-close]');

  function openPanel(which){
    backdrop.hidden = false;
    backdrop.classList.add('open');

    if (which === 'drawer'){
      drawer.classList.add('open');
      drawer.setAttribute('aria-hidden', 'false');
      if (account) { account.classList.remove('open'); account.setAttribute('aria-hidden','true'); }
    } else if (which === 'account' && account){
      account.classList.add('open');
      account.setAttribute('aria-hidden', 'false');
      drawer.classList.remove('open');
      drawer.setAttribute('aria-hidden', 'true');
    }

    toggles.forEach(btn => {
      const target = btn.getAttribute('data-nav-toggle');
      btn.setAttribute('aria-expanded', target === which ? 'true' : 'false');
    });
  }

  function closeAll(){
    drawer.classList.remove('open');
    drawer.setAttribute('aria-hidden', 'true');
    if (account){ account.classList.remove('open'); account.setAttribute('aria-hidden','true'); }
    backdrop.classList.remove('open');
    backdrop.hidden = true;
    toggles.forEach(btn => btn.setAttribute('aria-expanded', 'false'));
  }

  toggles.forEach(btn => {
    btn.addEventListener('click', () => {
      const target = btn.getAttribute('data-nav-toggle');
      const isOpen = (target === 'drawer') ? drawer.classList.contains('open') : (account && account.classList.contains('open'));
      if (isOpen) closeAll(); else openPanel(target);
    });
  });

  closers.forEach(btn => btn.addEventListener('click', closeAll));
  backdrop && backdrop.addEventListener('click', closeAll);

  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') closeAll();
  });

  // Close when resizing to desktop to avoid weird states
  window.addEventListener('resize', () => {
    if (window.innerWidth >= 900) closeAll();
  });
})();
</script>