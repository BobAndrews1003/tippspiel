{% load static %}
<link rel="stylesheet" href="{% static 'app.css' %}">

{% include "tipping/_nav.html" %}

<div class="container">

  <!-- Tabs (Matches / Bonus) -->
  <div class="tabs-modern">
    <a class="tab-modern {% if tab != 'bonus' %}active{% endif %}"
       href="{% url 'spieltag' %}?tab=matches{% if matchday %}&md={{ matchday }}{% endif %}">
      Tabla por fecha
    </a>

    {# ✅ Bonus-Tab-Link nur anzeigen, wenn sichtbar erlaubt #}
    {% if bonus_reveal %}
      <a class="tab-modern {% if tab == 'bonus' %}active{% endif %}"
         href="{% url 'spieltag' %}?tab=bonus{% if matchday %}&md={{ matchday }}{% endif %}">
        Pronósticos especiales
        {% if season_start %}
          <span class="pill">desde {{ season_start|date:"d.m H:i" }}</span>
        {% endif %}
      </a>
    {% endif %}
  </div>

  {# =================== BONUS TAB =================== #}
  {% if tab == "bonus" %}

    <div class="card header-card">
      <div class="header-flex">
        <div>
          <h2>Pronósticos especiales – {{ group.name }}</h2>
          {% if season_start %}
            <div class="muted small">Bloqueo: {{ season_start|date:"d.m.Y H:i" }}</div>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="card table-card">
      <div class="tablewrap-modern">
        <table>
          <thead>
            <tr>
              <th class="sticky-left pos">Pos</th>
              <th class="sticky-left name">Nombre</th>
              <th>Campeón (mitad de temporada)</th>
              <th>Campeón</th>
              <th>1er entrenador despedido</th>
              <th>Máximo goleador</th>
              <th>Desciende 1</th>
              <th>Desciende 2</th>
              <th class="sticky-right total">Bonus</th>
            </tr>
          </thead>

          <tbody>
            {% for row in bonus_rows %}
              <tr>
                <td class="sticky-left pos">{{ forloop.counter }}.</td>
                <td class="sticky-left name">{{ row.user.username }}</td>

                <td>{{ row.picks.herbstmeister|default:"—" }}</td>
                <td>{{ row.picks.meister|default:"—" }}</td>
                <td>{{ row.picks.trainer_first|default:"—" }}</td>
                <td>{{ row.picks.topscorer|default:"—" }}</td>
                <td>{{ row.picks.relegation1|default:"—" }}</td>
                <td>{{ row.picks.relegation2|default:"—" }}</td>

                <td class="sticky-right total">{{ row.points }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>

      <p class="note">
        Los pronósticos especiales se vuelven visibles al inicio de la temporada.
        Se suman a la puntuación total (5 puntos por cada acierto).
      </p>
    </div>


  {# =================== MATCHDAY TAB =================== #}
  {% else %}

    {% if matchday %}
      <div class="card header-card">
        <div class="header-flex">
          <div>
            <h2>Vista por fecha – Fecha {{ matchday }}</h2>
            <div class="muted small">Los pronósticos se revelan después del inicio del partido.</div>
          </div>

          <div class="toolbar-nav">
            <a class="btn small {% if not prev_md %}disabled{% endif %}"
               href="{% url 'spieltag' %}?tab=matches&md={{ prev_md }}">
              ◀
            </a>
            <a class="btn small {% if not next_md %}disabled{% endif %}"
               href="{% url 'spieltag' %}?tab=matches&md={{ next_md }}">
              ▶
            </a>
          </div>
        </div>
      </div>

      <div class="card table-card">
        <div class="tablewrap-modern">
          <table>
            <thead>
              <tr>
                <th class="sticky-left pos">Pos</th>
                <th class="sticky-left name">Nombre</th>

                {% for h in matches %}
                  <th>
                    <div class="match-head">
                      {{ h.match.home_team|slice:":3"|upper }}&nbsp;&nbsp;{{ h.match.away_team|slice:":3"|upper }}
                    </div>
                    <div class="match-sub">
                      {% if h.result %}
                        {{ h.result.0 }}:{{ h.result.1 }}
                      {% else %}
                        {{ h.match.kickoff|date:"d.m H:i" }}
                      {% endif %}
                    </div>
                  </th>
                {% endfor %}

                <th class="sticky-right total">P</th>
              </tr>
            </thead>

            <tbody>
              {% for row in table_rows %}
                <tr class="{% if row.user.id == request.user.id %}me{% endif %}">
                  <td class="sticky-left pos">{{ forloop.counter }}.</td>
                  <td class="sticky-left name">{{ row.user.username }}</td>

                  {% for c in row.cells %}
                    <td>
                      {% if c.reveal %}
                        {% if c.pred %}
                          <div class="tip">{{ c.pred.pred_home }}:{{ c.pred.pred_away }}</div>
                          <div class="pts">{{ c.points }}</div>
                        {% else %}
                          <div class="tip">—</div>
                          <div class="pts">0</div>
                        {% endif %}
                      {% else %}
                        <div class="hidden-tip">oculto</div>
                      {% endif %}
                    </td>
                  {% endfor %}

                  <td class="sticky-right total">{{ row.total_points }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>

    {% else %}
      <div class="card">
        <p>No se han encontrado partidos futuros.</p>
      </div>
    {% endif %}

  {% endif %}

</div>